# ============================================================================
# Ebook Metadata Pipeline - Configuration File
# ============================================================================
# Place this file alongside ebook_metadata_pipeline.py or at:
#   ~/.config/ebook-pipeline/config.yaml
#   /etc/ebook-pipeline/config.yaml
#
# CLI flags override values in this file.
# Environment variables (ANTHROPIC_API_KEY, GOOGLE_API_KEY) override both.
# ============================================================================

# ---------------------------------------------------------------------------
# Directories
# ---------------------------------------------------------------------------
ebook_dir: "/mnt/data/ebooks"
rdf_catalog: "~/gutenberg-rdf"
log_dir: null                       # null = <ebook_dir>/.metadata_logs

# ---------------------------------------------------------------------------
# API Keys (prefer env vars for security)
# ---------------------------------------------------------------------------
anthropic_api_key: null              # or set ANTHROPIC_API_KEY env var
google_api_key: null                 # or set GOOGLE_API_KEY env var
# Multiple Google keys for rotation (used round-robin when one hits 429):
# google_api_keys:
#   - "AIza..."
#   - "AIza..."
#   - "AIza..."

# ---------------------------------------------------------------------------
# Pipeline Stage Controls
# ---------------------------------------------------------------------------
skip_rdf: false                      # skip Gutenberg RDF catalog lookup
skip_api: false                      # skip Open Library + Google Books
skip_ai: false                       # skip Claude AI text analysis
skip_write: false                    # skip writing metadata back to files
skip_rename: false                   # skip file renaming
auto_download_rdf: false             # auto-download RDF catalog if missing

# ---------------------------------------------------------------------------
# Thresholds
# ---------------------------------------------------------------------------
api_threshold: 0.7                   # skip API if completeness >= this
ai_threshold: 0.4                    # skip AI if completeness >= this

# ---------------------------------------------------------------------------
# Processing Limits
# ---------------------------------------------------------------------------
limit: null                          # process only first N files (null = all)
threads: 1                           # concurrent file processing (future)
dry_run: false                       # preview changes without modifying files
verbose: false                       # debug-level output
force: false                         # reprocess files even if cached

# ---------------------------------------------------------------------------
# Rate Limiting
# ---------------------------------------------------------------------------
rate_limits:
  # Per-API request delays (seconds between calls)
  openlibrary:
    delay: 0.5                       # minimum seconds between requests
    max_retries: 3                   # retry count on 429/timeout
    backoff_base: 2.0                # exponential backoff multiplier
    circuit_breaker: 5               # disable after N consecutive 429s
    daily_limit: null                # max requests per day (null = unlimited)

  google_books:
    delay: 1.5                       # Google is stricter without API key
    max_retries: 3
    backoff_base: 2.0
    circuit_breaker: 5
    daily_limit: null

  anthropic:
    delay: 1.0                       # delay between Claude API calls
    max_retries: 2
    backoff_base: 3.0
    circuit_breaker: 3
    daily_limit: null                # useful for cost control
    max_tokens_per_run: null         # cap total tokens per pipeline run

  # Global rate control
  global:
    files_per_minute: null           # throttle overall processing speed
    files_per_hour: null             # null = unlimited
    pause_between_files: 0           # seconds to wait between each file

# ---------------------------------------------------------------------------
# Scheduling (used by the systemd service / wrapper script)
# ---------------------------------------------------------------------------
schedule:
  enabled: false                     # set true to enable automated runs
  mode: "incremental"                # "full" = all files, "incremental" = new/changed only
  watch_dirs:                        # directories to monitor for new files
    - "/mnt/data/ebooks"
    # - "/mnt/data/incoming"

  # Systemd timer schedule (OnCalendar format)
  # See: https://www.freedesktop.org/software/systemd/man/systemd.time.html
  calendar: "*-*-* 02:00:00"         # daily at 2 AM
  # Other examples:
  # calendar: "Mon *-*-* 02:00:00"   # weekly on Monday at 2 AM
  # calendar: "*-*-* *:00:00"        # every hour
  # calendar: "*-*-* 02,14:00:00"    # twice daily at 2 AM and 2 PM

  # Processing window - stop processing after this duration
  max_runtime_minutes: 240           # 4 hours max per run
  randomized_delay_sec: 300          # jitter to avoid API thundering herd

  # Notifications (optional)
  notify:
    on_complete: false               # log summary on completion
    on_error: false                  # log errors
    # webhook_url: null              # POST summary to webhook on completion

# ---------------------------------------------------------------------------
# File Matching
# ---------------------------------------------------------------------------
file_filters:
  # Only process these extensions (default: all supported)
  extensions: null                   # null = all, or [".epub", ".pdf"]
  # Exclude patterns (glob)
  exclude_patterns:
    - "*.tmp"
    - "*.partial"
    - ".DS_Store"
  # Minimum file size to process (bytes)
  min_file_size: 1024                # skip files < 1KB
  # Maximum file size to process (bytes)
  max_file_size: null                # null = no limit

# ---------------------------------------------------------------------------
# Cache
# ---------------------------------------------------------------------------
cache:
  enabled: true
  dir: null                          # null = <ebook_dir>/.metadata_cache
  ttl_days: 30                       # re-check files after this many days
  skip_unchanged: true               # skip files with same hash as last run
